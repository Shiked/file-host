document.addEventListener('DOMContentLoaded',()=>{const partialsBaseUrl='_includes/';const currentTheme=localStorage.getItem('theme');if(currentTheme==='dark'){document.body.classList.add('dark-theme');}
async function loadPartial(elementId,filePath,callback){const placeholder=document.getElementById(elementId);if(placeholder){try{const response=await fetch(filePath);if(!response.ok){throw new Error(`Failed to load ${filePath}:${response.statusText}`);}
const html=await response.text();placeholder.innerHTML=html;if(callback)callback();}catch(error){console.error('Error loading partial:',error);placeholder.innerHTML=`<p style="color:red;">Error loading content for ${elementId}.</p>`;}}}
loadPartial('page-header-placeholder',partialsBaseUrl+'_header.html',()=>{const pageTitleH1=document.getElementById('pageTitleH1');const pageTitleFromBody=document.body.dataset.pageTitle;if(pageTitleH1&&pageTitleFromBody){pageTitleH1.textContent=pageTitleFromBody;}
populateBreadcrumbs();initSearch();const loadedToggleThemeButton=document.getElementById('toggleTheme');if(loadedToggleThemeButton){if(document.body.classList.contains('dark-theme')){loadedToggleThemeButton.textContent='☀️';}else{loadedToggleThemeButton.textContent='🌓';}
loadedToggleThemeButton.addEventListener('click',()=>{document.body.classList.toggle('dark-theme');let theme='light';if(document.body.classList.contains('dark-theme')){theme='dark';loadedToggleThemeButton.textContent='☀️';}else{loadedToggleThemeButton.textContent='🌓';}
localStorage.setItem('theme',theme);});}});loadPartial('main-nav-placeholder',partialsBaseUrl+'_nav.html');loadPartial('sitetree-placeholder',partialsBaseUrl+'_sitetree.html',()=>{initTree('fileTree');});function populateBreadcrumbs(){const breadcrumbsContainer=document.getElementById('breadcrumbs');const breadcrumbsDataAttr=document.body.dataset.breadcrumbs;if(breadcrumbsContainer&&breadcrumbsDataAttr){try{const breadcrumbsArray=JSON.parse(breadcrumbsDataAttr);let html='';breadcrumbsArray.forEach((crumb,index)=>{if(index===breadcrumbsArray.length-1){html+=`<li class="breadcrumb-item active"aria-current="page">${crumb.name}</li>`;}else{html+=`<li class="breadcrumb-item"><a href="${crumb.url}">${crumb.name}</a></li>`;}});breadcrumbsContainer.innerHTML=html;}catch(e){console.error("Error parsing breadcrumbs data:",e);}}}
function initSearch(){const searchInput=document.getElementById('searchInput');if(!searchInput)return;const searchableItems=document.querySelectorAll('.searchable-item');const searchableSections=document.querySelectorAll('.searchable-section');searchInput.addEventListener('input',(event)=>{const query=event.target.value.toLowerCase().trim();searchableItems.forEach(item=>{const filename=(item.dataset.filename||'').toLowerCase();const tags=(item.dataset.tags||'').toLowerCase();const contentText=item.textContent.toLowerCase();const isVisible=filename.includes(query)||tags.includes(query)||contentText.includes(query);item.style.display=isVisible?'':'none';});searchableSections.forEach(section=>{if(query.length>0&&section.tagName==='DETAILS'&&!section.open){let hasMatchInside=false;section.querySelectorAll('.searchable-item').forEach(innerItem=>{const filename=(innerItem.dataset.filename||'').toLowerCase();const tags=(innerItem.dataset.tags||'').toLowerCase();const contentText=innerItem.textContent.toLowerCase();if(filename.includes(query)||tags.includes(query)||contentText.includes(query)){hasMatchInside=true;}});if(hasMatchInside){section.open=true;}}});});}
const lightGalleryContainers=document.querySelectorAll('.lightgallery-container');if(lightGalleryContainers.length>0&&typeof lightGallery==='function'){lightGalleryContainers.forEach(container=>{lightGallery(container,{plugins:(typeof lgZoom!=='undefined'&&typeof lgThumbnail!=='undefined')?[lgZoom,lgThumbnail]:[],selector:'.gallery-item',speed:500,download:true,thumbnail:true,subHtmlSelectorRelative:true});});}else if(lightGalleryContainers.length>0){console.warn("LightGallery function or plugins not found. Ensure the library is loaded.");}
function initTree(treeId){const tree=document.getElementById(treeId);if(!tree)return;const folders=tree.querySelectorAll('li.folder');folders.forEach(folderLi=>{const firstChild=folderLi.firstChild;const ulSubMenu=folderLi.querySelector('ul');if(ulSubMenu){ulSubMenu.style.display='none';folderLi.style.cursor='pointer';folderLi.addEventListener('click',function(event){if(event.target.tagName==='A'||event.target.closest('a')){return;}
event.stopPropagation();const isCurrentlyOpen=ulSubMenu.style.display==='block';ulSubMenu.style.display=isCurrentlyOpen?'none':'block';});}});}
window.copyLink=function(event,buttonElement){event.preventDefault();event.stopPropagation();const urlToCopy=buttonElement.dataset.url;if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(urlToCopy).then(()=>{const originalText=buttonElement.textContent;buttonElement.textContent='Copied!';setTimeout(()=>{buttonElement.textContent=originalText;},2000);}).catch(err=>{console.warn('Failed to copy with Clipboard API:',err);fallbackCopyTextToClipboard(urlToCopy,buttonElement);});}else{fallbackCopyTextToClipboard(urlToCopy,buttonElement);}};function fallbackCopyTextToClipboard(text,buttonElement){const textArea=document.createElement("textarea");textArea.value=text;textArea.style.position="fixed";textArea.style.opacity=0;document.body.appendChild(textArea);textArea.focus();textArea.select();try{const successful=document.execCommand('copy');const originalText=buttonElement.textContent;if(successful){buttonElement.textContent='Copied!';setTimeout(()=>{buttonElement.textContent=originalText;},2000);}else{buttonElement.textContent='Copy Failed';setTimeout(()=>{buttonElement.textContent=originalText;},2000);}}catch(err){console.error('Fallback copy failed:',err);const originalText=buttonElement.textContent;buttonElement.textContent='Copy Failed';setTimeout(()=>{buttonElement.textContent=originalText;},2000);}
document.body.removeChild(textArea);}});